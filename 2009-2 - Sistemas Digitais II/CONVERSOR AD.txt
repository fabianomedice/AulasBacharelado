
         XDEF main 


          Include 'qtqy_registers.inc' ; For the QT1, QT2, QT4, QY1, QY2, QY4 


DEFAULT_RAM SECTION SHORT 

; Place RAM Variables here 
TEMPO: DS 1 
HORA: DS 1 
MIN: DS 1 
SEG: DS 1 
DECEN: DS 1 
CARACTER: DS 2 
EBUFFER: DS 2 

AUXILIAR: DS 2
AUXCONV: DS 1 
MEDIAH: DS 1 
MEDIABCD: DS 2 
MEDIAVOLTS: DS 2 
MEDIAVOLTS2: DS 2 
BUFFER: DS 32 

DEFAULT_ROM SECTION 

main: 
	MOV #$39,CONFIG1 ; DESABILITA STOP, COP, LVI +5V 
	MOV #0,CONFIG2 ; OSCILADOR INTERNO , SEM RESET, COM IRQ E PULLUP 
	MOV #$3,DDRA 
	;MOV #$3,PTAPUE ; RESISTOR DE PULL UP NO PTA0 E PTA1 
	CLR PORTA ; DESATIVA AS SAIDAS (OU CLR $00) 
	LDHX #100 
	STHX TMODH ; ESTABELECE O MODO DE CONTAGEM 50000 
	MOV #$30,TSC ; PARA E RESETA O TIMER 
	MOV #$46,TSC ; ATIVA O TIMER E DIVIDE A FREQ POR 
	MOV #$62,ADSCR ; PTA4,INT,CONV CONTINUA 
	MOV #$80,ADICLK ; 12500 CONV/SEG 
	ZERARAM: 
	LDHX #$80 
LZ: 
	CLR ,X 
	INCX 
	BNE LZ 
	MOV #$12,HORA 
	MOV #$30,MIN 
	
	LDHX #BUFFER 
	STHX EBUFFER
	LDA #$FF 
LB: 
	STA ,X 
	INCX 
	CPHX #BUFFER+32 
	BNE LB 
	LDHX #BUFFER 
	STHX EBUFFER 
	CLI 
SOMABUFFER: LDHX #0 
	STHX  AUXILIAR 
	LDHX #BUFFER 
	LDA ,X 
SOMAMAIS: 
	INCX 
	ADD ,X 
	BCC NAOTEM 
	INC AUXILIAR 
NAOTEM: 
	CPHX #BUFFER+31 
	BNE SOMAMAIS 
	STA AUXILIAR+1 
TIRAMEDIA: 
	LDX #5 
RODAMAIS: 
	CLC 
	ROR AUXILIAR 
	ROR AUXILIAR+1 
	DBNZX RODAMAIS 
	MOV AUXILIAR+1,MEDIAH 
	LDA MEDIAH 
	JSR HEXABCD 
	JSR CONVVOLTS
	JSR CONVVOLTS2
	BRA SOMABUFFER 
CONVVOLTS: 
	LDHX #0 
	STHX AUXILIAR 
	LDHX MEDIABCD 
	LDA MEDIABCD+1 
	ADD MEDIABCD+1 
	DAA 
	STA AUXILIAR+1 
	LDA MEDIABCD 
	ADC MEDIABCD ; SOMA COM CARRY 
	STA AUXILIAR 
	LDHX AUXILIAR 
	STHX MEDIAVOLTS 
	RTS 
CONVVOLTS2: 
	LDA MEDIAH 
	LDX #5 
	MUL 
	PSHX 
	PULH 
	LDX #$FF 
	DIV ; A=PARTE INTEIRA 
	STA MEDIAVOLTS2 
	CLRA 
	DIV 
	STA AUXCONV
	JSR CONVDECENT
	MOV AUXILIAR,MEDIAVOLTS2+1
	RTS 
;***************************** CONVERTE PARTE FRACIONARIA DE HEXA PARA DECIMAL****************
;ENTRADA:AUXCONV
;SAIDA CONV 
CONVDECENT
   LDHX #0
   STHX AUXILIAR
    LDA AUXCONV  ;  ZW fracionaria
    NSA
    AND #$0F ; 0Z
    BEQ SOMAW1  ; SE Z=0 NAO SOMA 63 (62,5)  
    TAX  ;0Z  
    CLRA
SOMAZ
    ADD #$25;DECIMOS
    DAA
    BCC S1
    PSHA    
    LDA AUXILIAR  ; CONV=CONV+1 CASA UNIDADES/DECIMOS
    ADD #1
    DAA
    STA AUXILIAR
    PULA
S1    DBNZX SOMAZ
    STA AUXILIAR+1  
    
SOMAW1     
    LDA AUXCONV ;ZW  
    AND #$0F ;0W
    BEQ FSOMA   ; SE W=O NAO SOM 4  (3,9)
    TAX
    LDA AUXILIAR+1
SOMAW
    ADD #$39;CENTESIMOS
    DAA
    BCC S2
    PSHA    
    LDA AUXILIAR  ; CONV=CONV+1 CASA UNIDADES/DECIMOS
    ADD #1
    DAA
    STA AUXILIAR
    PULA
S2    DBNZX SOMAW
    STA AUXILIAR+1
FSOMA:    
    LDA AUXCONV ; ZW
    NSA
    AND #$0F; 0Z
    BEQ PULASOMA
    TAX ;OZ
    
    LDA AUXILIAR
MAIS2:ADD #$6
    DAA
    DBNZX MAIS2
    STA AUXILIAR
PULASOMA:        
  
    LDA AUXILIAR+1
    AND #$0F
    CMP #$5
    BCS CONT
    LDA AUXILIAR+1
    ADD #$10
    DAA
    STA AUXILIAR+1
CONT:
    LDA AUXILIAR+1
    NSA
    AND #$0F
    CMP #$5
    BCS CONT2
    LDA AUXILIAR
    ADD #$1
    DAA
    STA AUXILIAR
    
CONT2:RTS    
             

HEXABCD: LDHX #0 
	STHX AUXILIAR 
	PSHA ;5B 
	NSA ; B5 
	AND #$0F ; 05 
	TAX ; X = 5 
	BEQ NAOSOMA 
	CLRA ;A = 0 
KA: 
	ADD #$16 ;A = 0 +16 +16 = 2C = 32 + 16 + 16 = 5E 
	DAA ;5E = 64 + 16 = 7A = 80 
	BCC CONTCONV 
	INC AUXILIAR 
CONTCONV: 
	DBNZX KA 
	STA AUXILIAR+1 
NAOSOMA: 
	PULA ;5B 
	AND #$0F ;0B 
	ADD #0 
	DAA 
	ADD AUXILIAR+1 
	DAA 
	BCC TERMINA 
	INC AUXILIAR 
TERMINA: 
	STA AUXILIAR+1 

	LDHX AUXILIAR 
	STHX MEDIABCD 

	RTS 


	
	
IMPRESS: 
	BSET 1,PORTA 
OCUPADA: 
	BRSET 0,PORTA,OCUPADA 
	STA PORTB 
	BCLR 1,PORTA 
RECEBEU: 
	BRSET 1,PORTA,RECEBEU 
	BSET 1,PORTA 
	RTS 
	
ROTTIMER: 
	LDA DECEN 
	ADD #1 
	DAA 
	STA DECEN 
	BNE SAIR 
	LDA SEG 
	ADD #1 
	DAA 
	STA SEG 
	CMP #$60 
	BNE SAIR 
	CLR SEG 
	LDA MIN 
	ADD #1 
	DAA 
	STA MIN 
	CMP #$60 
	BNE SAIR 
	CLR MIN 
	LDA HORA 
	ADD #1 
	DAA 
	STA HORA 
	CMP #$24 
	BNE SAIR 
	CLR HORA 

SAIR: BCLR 7,TSC 
	RTI 
	
ROTAD: 
	PSHH 
	LDHX EBUFFER 
	LDA ADR 
	STA ,X 
	INCX 
	STHX EBUFFER 
	CPHX #BUFFER+32 
	BNE SAI 
	LDHX #BUFFER 
    STHX EBUFFER 
SAI: 
	PULH 
	RTI 
MEUNOME: 
	DC.B 'MAE DA AMANDA MANDOU',$0 

	ORG $FFDE 
	DC.W ROTAD 
	ORG $FFF2 
	DC.W ROTTIMER 



	END


--------------------------------------------------------------------------------


No virus found in this incoming message.
Checked by AVG Free Edition. 
Version: 7.5.503 / Virus Database: 269.15.13/1099 - Release Date: 30/10/2007 10:06
